"use strict";(()=>{var e={};e.id=170,e.ids=[170],e.modules={4379:e=>{e.exports=require("@pinecone-database/pinecone")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9648:e=>{e.exports=import("axios")},360:e=>{e.exports=import("langchain/chains")},8490:e=>{e.exports=import("langchain/chat_models/openai")},4405:e=>{e.exports=import("langchain/embeddings/openai")},3478:e=>{e.exports=import("langchain/schema")},3244:e=>{e.exports=import("langchain/vectorstores/pinecone")},8653:(e,t,n)=>{n.a(e,async(e,o)=>{try{n.r(t),n.d(t,{config:()=>p,default:()=>c,routeModule:()=>u});var a=n(1802),i=n(7153),s=n(6249),r=n(8037),l=e([r]);r=(l.then?(await l)():l)[0];let c=(0,s.l)(r,"default"),p=(0,s.l)(r,"config"),u=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/chat",pathname:"/api/chat",bundlePath:"",filename:""},userland:r});o()}catch(e){o(e)}})},7541:(e,t,n)=>{if(n.d(t,{E:()=>a,_:()=>o}),!process.env.PINECONE_INDEX_NAME)throw Error("Missing Pinecone index name in .env file");let o=process.env.PINECONE_INDEX_NAME??"",a="electoral-commission"},8037:(e,t,n)=>{n.a(e,async(e,o)=>{try{n.r(t),n.d(t,{default:()=>handler});var a=n(4405),i=n(3244),s=n(3478),r=n(556),l=n(1734),c=n(7541),p=n(9648),u=e([a,i,s,r,l,p]);async function handler(e,t){let{question:n,history:o,conversationId:u}=e.body;if("POST"!==e.method){t.status(405).json({error:"Method not allowed"});return}if(!n)return t.status(400).json({message:"No question in the request"});let d=n.trim().replaceAll("\n"," ");try{let e=l.O.Index(c._),h=await i.PineconeStore.fromExistingIndex(new a.OpenAIEmbeddings({}),{pineconeIndex:e,textKey:"text",namespace:c.E}),m=(0,r.F)(h),g=o.map((e,t)=>t%2==0?new s.HumanMessage(e):new s.AIMessage(e)),E=await m.call({question:d,chat_history:g});console.log("sanitizedQuestion:",d);let w=[...o,n,E.text],v=process.env.CHAT_API_URL||"http://localhost:8000/api/chat/",_=await p.default.post(v,{history:w,response:E,conversationId:u});200!==_.status&&console.error("Failed to store chat history in Django",_.data),console.log("response",E),t.status(200).json(E)}catch(e){console.log("error",e),t.status(500).json({error:e.message||"Something went wrong"})}}[a,i,s,r,l,p]=u.then?(await u)():u,o()}catch(e){o(e)}})},556:(e,t,n)=>{n.a(e,async(e,o)=>{try{n.d(t,{F:()=>makeChain});var a=n(8490),i=n(360),s=e([a,i]);[a,i]=s.then?(await s)():s;let r=`Given the following conversation and a follow up question, rephrase the follow up question to be a standalone question.

Chat History:
{chat_history}
Follow Up Input: {question}
Standalone question:`,l=`{context}

You're a cheerful, helpful, slightly posh AI assistant, excited to be providing advice on legal duties and political finance regulations around UK elections. Use the context to answer the question at the end.
If you don't know the answer, say you don't know and provide examples of more relevant questions.
If the question is not related to the duties of the Electoral Commission, suggest more relevant questions they could ask instead.
Your name is Edward Charles. Use British English spelling. 

Question: {question}`,makeChain=e=>{let t=new a.ChatOpenAI({temperature:0,modelName:"gpt-3.5-turbo-1106"}),n=i.ConversationalRetrievalQAChain.fromLLM(t,e.asRetriever(),{qaTemplate:l,questionGeneratorTemplate:r,returnSourceDocuments:!0});return n};o()}catch(e){o(e)}})},1734:(e,t,n)=>{n.a(e,async(e,o)=>{try{n.d(t,{O:()=>e});var a=n(4379);if(!process.env.PINECONE_ENVIRONMENT||!process.env.PINECONE_API_KEY)throw Error("Pinecone environment or api key vars missing");async function initPinecone(){try{let e=new a.PineconeClient;return await e.init({environment:process.env.PINECONE_ENVIRONMENT??"",apiKey:process.env.PINECONE_API_KEY??""}),e}catch(e){throw console.log("error",e),Error("Failed to initialize Pinecone Client")}}let e=await initPinecone();o()}catch(e){o(e)}},1)}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),n=t.X(0,[222],()=>__webpack_exec__(8653));module.exports=n})();